# container-filebeat.service
# based off
#   podman generate systemd filebeat --restart-policy always --new --name
# with pid/cidfiles replaced with --sdnotify=conmon approach

[Unit]
Description=Podman container-filebeat.service
Documentation=man:podman-generate-systemd(1)
Wants=network.target
After=network-online.target

[Service]
Environment=PODMAN_SYSTEMD_UNIT=%n
Restart=always
ExecStart=/usr/bin/podman run \
  --network slirp4netns:cidr={{ podman_cidr }} \
  --sdnotify=conmon \
  --cgroups=no-conmon \
  --replace \
  --name {{ zenith_proxy_mitm_container_name }} \
  --restart=always \
  --security-opt label=disable \
  --detach=True \
  --env ZENITH_PROXY_LISTEN_PORT={{ zenith_proxy_mitm_listen_port }} \
  --env ZENITH_PROXY_UPSTREAM_SCHEME={{ zenith_proxy_upstream_scheme }} \
  --env ZENITH_PROXY_UPSTREAM_HOST={{ zenith_proxy_upstream_host }} \
  --env ZENITH_PROXY_UPSTREAM_PORT={{ zenith_proxy_upstream_port }} \
{% if zenith_proxy_upstream_read_timeout %}
  --env ZENITH_PROXY_READ_TIMEOUT={{ zenith_proxy_upstream_read_timeout }} \
{% endif %}
{% if zenith_proxy_mitm_auth_inject == "basic" %}
  --env ZENITH_PROXY_AUTH_INJECT=basic \
  --env ZENITH_PROXY_AUTH_BASIC_USERNAME={{ zenith_proxy_mitm_auth_basic_username }} \
  --env {{ "ZENITH_PROXY_AUTH_BASIC_PASSWORD={}".format(zenith_proxy_mitm_auth_basic_password) | quote }} \
{% elif zenith_proxy_mitm_auth_inject == "bearer" %}
  --env ZENITH_PROXY_AUTH_INJECT=bearer \
  --env ZENITH_PROXY_AUTH_BEARER_HEADER={{ zenith_proxy_mitm_auth_bearer_header_name }} \
  --env ZENITH_PROXY_AUTH_BEARER_PREFIX={{ zenith_proxy_mitm_auth_bearer_header_prefix }} \
  --env ZENITH_PROXY_AUTH_BEARER_TOKEN={{ zenith_proxy_mitm_auth_bearer_token }} \
{% endif %}
  {{ zenith_proxy_mitm_image }}
ExecStop=/usr/bin/podman stop --ignore {{ zenith_proxy_mitm_container_name }} -t 10
ExecStopPost=/usr/bin/podman rm --ignore -f {{ zenith_proxy_mitm_container_name }}
KillMode=none
Type=notify
NotifyAccess=all
User={{ zenith_proxy_podman_user }}
Group={{ zenith_proxy_podman_user }}
TimeoutStartSec=180

[Install]
WantedBy=multi-user.target default.target
