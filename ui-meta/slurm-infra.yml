name: "slurm"
label: "Slurm"
description: Batch cluster running the Slurm workload manager.
logo: https://upload.wikimedia.org/wikipedia/commons/thumb/3/3a/Slurm_logo.svg/158px-Slurm_logo.svg.png

parameters:
  - name: cluster_floating_ip
    label: External IP
    description: The external IP to use for the login node.
    kind: cloud.ip
    immutable: true

  - name: compute_count
    label: Compute node count
    description: The number of compute nodes in the cluster.
    kind: integer
    options:
      min: 1
    default: 3

  - name: login_flavor
    label: Login node size
    description: The size to use for the login node.
    kind: "cloud.size"
    immutable: true
    options:
      min_ram: 2048
      min_disk: 10

  - name: control_flavor
    label: Control node size
    description: The size to use for the control node.
    kind: "cloud.size"
    immutable: true
    options:
      min_ram: 2048
      min_disk: 10

  - name: compute_flavor
    label: Compute node size
    description: The size to use for the compute node.
    kind: "cloud.size"
    immutable: true
    options:
      min_ram: 2048
      min_disk: 10

  - name: cluster_monitoring_enabled
    label: Cluster monitoring
    description: |
      If selected, a monitoring stack will be deployed allowing you to track and visualise the
      state of the cluster.  
      WARNING: This can take a significant amount of time to deploy and configure.
    kind: boolean
    required: false
    default: true
    options:
      checkboxLabel: Enable cluster monitoring?

  - name: cluster_run_validation
    label: Post-configuration validation
    description: >-
      If selected, post-configuration jobs will be executed to validate the core functionality
      of the cluster when it is re-configured.
    kind: boolean
    required: false
    default: true
    options:
      checkboxLabel: Run post-configuration validation?

usage_template: |-
  Access to the cluster is via the external IP using SSH as the `rocky` user:

  ```
  $ ssh rocky@{{ cluster.outputs.cluster_access_ip | default('<cluster ip>') }}
  [rocky@{{ cluster.name }}-login-0 ~]$ sinfo
  PARTITION AVAIL  TIMELIMIT  NODES  STATE NODELIST
  compute*     up 60-00:00:0    {{ "%3s" | format(cluster.parameter_values.compute_count) }}   idle {{ cluster.name }}-compute-[0-{{ cluster.parameter_values.compute_count - 1 }}]
  ```

  The SSH public key of the user that deployed the cluster is injected. Access can be granted
  to additional users by placing their SSH public key in `~rocky/.ssh/authorized_keys`.

services:
  - name: monitoring
    label: Monitoring
    icon_url: https://raw.githubusercontent.com/cncf/artwork/master/projects/prometheus/icon/color/prometheus-icon-color.png
    when: cluster_monitoring_enabled
